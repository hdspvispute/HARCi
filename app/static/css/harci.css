@tailwind base;
@tailwind components;
@tailwind utilities;

/* ===== Base / Theme ===== */
@layer base {
  :root{
    --brand-red:#E60027;

    /* iOS safe areas */
    --sai-b: env(safe-area-inset-bottom);
    --sai-t: env(safe-area-inset-top);

    /* Footer heights (class-switched, no measuring) */
    --footer-h-collapsed: 128px;  /* chips + mic */
    --footer-h-expanded:  184px;  /* chips + mic + ask form */
    --footer-h: var(--footer-h-collapsed);

    /* focus ring token */
    --focus-ring: rgba(230,0,39,.55);
  }

  html,body{ height:100%; }
  html{ -webkit-tap-highlight-color:transparent; }
  body.ask-open { --footer-h: var(--footer-h-expanded); }
}

/* ===== Utilities ===== */
@layer utilities {
  .aspect-video{ aspect-ratio:16/9; }
  .no-callout{ -webkit-touch-callout:none; }
  .no-select{ -webkit-user-select:none; user-select:none; }
  .tap-manipulation{ touch-action:manipulation; }

  .scrollbar-none{ -ms-overflow-style:none; scrollbar-width:none; }
  .scrollbar-none::-webkit-scrollbar{ display:none; }
  .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  .no-scrollbar::-webkit-scrollbar{ display:none; }

  .focus-ring:focus-visible{
    outline: 2px solid var(--focus-ring);
    outline-offset: 2px;
  }

  /* DO NOT scale on press; keep only visual hint */
  .pressing{ transform: none !important; filter: brightness(.98); }
}

/* ===== Components ===== */
@layer components {
  .card{ @apply rounded-2xl border border-white/10 bg-neutral-900/40; }

  .btn{
    @apply inline-flex items-center justify-center gap-2 rounded-2xl px-4 py-2.5
           border border-white/10 bg-white/5 text-white hover:bg-white/10
           transition duration-200
           disabled:opacity-50 disabled:cursor-not-allowed
           no-select no-callout tap-manipulation focus-ring;
    line-height:1;
  }
  .btn-brand{ @apply border-transparent text-white; background:var(--brand-red); }
  .btn-brand:hover{ filter:brightness(1.08); }
  .btn-outline{ @apply border-white/30 bg-transparent hover:bg-white/10; }
  .btn-plain{ @apply bg-transparent border-transparent text-white/70 hover:text-white hover:bg-white/10; }

  .btn-xs{ @apply h-7 px-2 py-1 text-[11px] rounded-xl; }
  .btn-icon{ @apply h-10 w-10 p-0 rounded-2xl flex items-center justify-center; }

  /* Large rectangular mic */
  .btn-mic-rect{
    @apply rounded-xl h-12 w-[min(100%,32rem)] md:h-14 md:w-[22rem]
           text-sm md:text-base font-semibold shadow-lg;
    background:var(--brand-red);
  }
  .btn-mic-rect.is-pressed{ filter:brightness(.98); }

  .chip{
    @apply px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-sm
           hover:bg-white/10 whitespace-nowrap focus-ring;
  }

  .input{
    @apply w-full rounded-2xl px-3 py-2.5 bg-white/5 text-white placeholder-white/50
           border border-white/10 focus:outline-none focus:ring-2
           focus:ring-[var(--brand-red)] focus:border-transparent
           disabled:opacity-50 disabled:cursor-not-allowed;
  }

  /* Strong disabled visuals */
  .btn:disabled,.btn[aria-disabled="true"],
  .btn-mic-rect:disabled,.btn-mic-rect[aria-disabled="true"]{
    @apply opacity-40 grayscale saturate-0 contrast-75 brightness-75 pointer-events-none;
    box-shadow:none;
  }
  .btn-brand:disabled,.btn-brand[aria-disabled="true"]{ @apply ring-1 ring-white/15; }
  .chip:disabled,.chip[aria-disabled="true"]{ @apply bg-neutral-700/30 border-dashed border-white/25 text-white/55 pointer-events-none; }
  .input:disabled,.input[aria-disabled="true"]{ @apply bg-neutral-700/20 text-white/60 border-white/15; }
  .input:disabled::placeholder,.input[aria-disabled="true"]::placeholder{ @apply text-white/30; }

  /* Chip scrollers fade edges */
  .chip-scroll{
    @apply overflow-x-auto scrollbar-none;
    -webkit-mask-image:linear-gradient(to right, transparent 0, #000 24px, #000 calc(100% - 24px), transparent);
            mask-image:linear-gradient(to right, transparent 0, #000 24px, #000 calc(100% - 24px), transparent);
  }
}

/* ===== States / Effects ===== */
body.idle #remoteVideo{ filter:brightness(.88) saturate(.95); }
#quickChips:has(button:disabled){ filter:grayscale(100%) brightness(.9); }

/* status dot colors driven by body classes */
body.state-ready    #statusDot{ background:#10B981; } /* green */
body.state-listening#statusDot{ background:var(--brand-red); } /* red */
body.state-thinking #statusDot,
body.state-speaking #statusDot{ background:#F59E0B; } /* amber */

/* ===== Prose tweaks ===== */
.prose h1{ @apply text-xl font-bold mt-2 mb-1; }
.prose h2{ @apply text-lg font-semibold mt-2 mb-1; }
.prose h3{ @apply text-base font-semibold mt-2 mb-1; }
.prose ul{ @apply list-disc ml-6; }
.prose p { @apply leading-relaxed; }

/* ===== Media surfaces ===== */
#remoteVideo{ @apply w-full h-full object-cover bg-black; }
#briefImage { @apply w-full object-cover; }

/* default dot + ios context menu guard */
#statusDot{ background:#10B981; }
#btnHoldMic{ -webkit-touch-callout:none; }

/* ========================================================================== */
/*            HARD LAYOUT: fixed header/footer, scrollable briefing           */
/* ========================================================================== */
html,body{ overflow:hidden; }

/* Fixed header */
header{
  position:fixed; top:0; left:0; right:0; z-index:50; height:4rem;
  padding-top:max(0px, var(--sai-t));
}

/* Footer is fixed */
footer{
  position:fixed; left:0; right:0; bottom:0; z-index:40;
}

/* Subtle busy hint on video */
body.ui-busy #remoteVideo{ filter:brightness(.85) saturate(.95); }

/* Fill <main> */
#guide-viewport{
  height: 100%;
  overflow: hidden;   /* only the briefing section scrolls */
}

/* Only the briefing section scrolls; reserve space for the fixed footer */
section.briefing-scroll{
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  min-height: 0;

  /* Keep content above chips + mic; expands when .ask-open toggles footer size */
  padding-bottom: calc(var(--footer-h) + var(--sai-b) + 16px) !important;
  scroll-padding-bottom: calc(var(--footer-h) + var(--sai-b) + 16px);
}

@media (min-width:768px){
  section.briefing-scroll{
    padding-bottom: calc(var(--footer-h) + var(--sai-b) + 8px) !important;
    scroll-padding-bottom: calc(var(--footer-h) + var(--sai-b) + 8px);
  }
}

/* Keep the inner #briefing content unconstrained */
#briefing{ overflow:visible; max-height:none; }

/* ===================== Mic stability (no transform changes) ===================== */

/* Mic: never transform; reset Tailwind transform vars as well */
#btnHoldMic{
  position: static;
  margin: 0 !important;
  flex-shrink: 0;
  backface-visibility: hidden;
  -webkit-font-smoothing: antialiased;
  --tw-translate-x: 0 !important;
  --tw-translate-y: 0 !important;
  --tw-scale-x: 1 !important;
  --tw-scale-y: 1 !important;
  transform: none !important;
  transition: none !important;
}

/* Neutralize ALL press-time transforms (active and any .pressing usage) */
#btnHoldMic:active,
.btn-mic-rect:active,
.btn-mic-rect.pressing,
#btnHoldMic.pressing{
  --tw-translate-x: 0 !important;
  --tw-translate-y: 0 !important;
  --tw-scale-x: 1 !important;
  --tw-scale-y: 1 !important;
  transform: none !important;
  transition: none !important;
}

/* Keep a visual cue without layout shift */
.btn-mic-rect.is-pressed{ filter: brightness(.98); }

/* Prevent long-press menus / selection just for the mic */
#btnHoldMic, #btnHoldMic * {
  -webkit-touch-callout: none !important;
  -webkit-user-select: none !important;
  user-select: none !important;
  -webkit-user-drag: none !important;
  touch-action: none !important;
}

/* === Mic stability: keep the same transform even when "pressed" === */

/* Center it once */
#btnHoldMic{
  position: relative;
  left: 50%;
  transform: translateX(-50%);   /* anchor horizontally */
  margin: 0 !important;
  flex-shrink: 0;
  backface-visibility: hidden;
  -webkit-font-smoothing: antialiased;
}

/* Keep the same transform while pressed/disabled AND if a ".pressing" class is toggled */
#btnHoldMic:active,
#btnHoldMic[disabled],
#btnHoldMic[aria-disabled="true"],
#btnHoldMic.pressing,           /* ← NEW: cancel .pressing scale on mic */
.btn-mic-rect.pressing{         /* ← NEW: also catch the class on the component class */
  --tw-translate-x: -50% !important;
  --tw-translate-y: 0 !important;
  --tw-scale-x: 1 !important;
  --tw-scale-y: 1 !important;
  transform: translateX(-50%) !important;
}
