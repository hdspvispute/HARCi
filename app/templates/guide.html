{% extends "_base.html" %}
{% block title %}Guide · HARCi{% endblock %}
{% block content %}

<!-- Viewport (fills page-root; only the briefing content will scroll) -->
<div id="guide-viewport" class="h-full px-4 md:px-6 lg:px-8 min-h-0">
  <div class="h-full min-h-0 flex flex-col md:grid md:grid-cols-12 gap-3 md:gap-4">

    <!-- Avatar -->
    <section class="relative overflow-hidden rounded-2xl border border-white/10 bg-black
                    shrink-0 md:col-span-7 lg:col-span-8">

      <!-- Audio unlock nudge — overlay; no layout shift -->
      <div id="audioNudge" class="pointer-events-none absolute right-3 top-3 z-30">
        <div class="pointer-events-auto rounded-full border border-white/10 bg-neutral-900/80 shadow-lg px-3 py-2 flex items-center gap-2">
          <span class="text-[11px] text-neutral-200">Tap to enable sound</span>
          <button id="btnEnableAudio" type="button" class="btn btn-brand text-[11px] py-1 px-2">Enable</button>
        </div>
      </div>

      <div class="aspect-video md:h-full">
        <video id="remoteVideo" class="h-full w-full object-cover bg-black" playsinline autoplay muted></video>
      </div>
      <audio id="remoteAudio" playsinline></audio>

      <!-- Single, stateful status pill -->
      <div id="statusPill"
           class="absolute left-3 top-3 rounded-full border border-white/10 bg-neutral-900/70
                  px-3 py-1 text-[12px] flex items-center gap-2 shadow">
        <span id="statusDot" class="h-2.5 w-2.5 rounded-full bg-emerald-500"></span>
        <span id="statusText" aria-live="polite">Preparing…</span>
      </div>
    </section>

    <!-- Briefing column (no Tips bar) -->
    <section class="rounded-2xl border border-white/10 bg-neutral-800/50
                    md:col-span-5 lg:col-span-4 flex flex-col min-h-0">

      <!-- Scrollable briefing content -->
      <div class="flex-1 min-h-0 overflow-auto overscroll-contain px-4 py-4">
        <div id="briefing" class="prose prose-invert max-w-none text-sm leading-snug">
          <h2 class="text-base font-semibold mb-1">Getting started</h2>
          <ul class="mt-1">
            <li>Hold <strong>Hold &amp; Speak</strong> to talk, release to send.</li>
            <li>Tap chips or open the Ask box to type.</li>
          </ul>
        </div>

        <!-- Optional image -->
        <div id="imagePanel" class="hidden mt-3 overflow-hidden rounded-xl border border-white/10 bg-neutral-900/40">
          <img id="briefImage" alt="" class="w-full object-cover" />
          <div class="p-2 text-[11px] text-neutral-300"><span id="imgAlt"></span></div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Sticky/Fixed footer controls -->
<footer class="fixed inset-x-0 bottom-0 border-t border-white/10 bg-neutral-950/70 backdrop-blur">
  <div class="footer-inner w-full max-w-screen px-4 pt-2"
       style="padding-bottom: calc(var(--safe-bottom) + 0.5rem);">

    <!-- Chips row (with Ask toggle on the right) -->
    <div class="flex items-center gap-2">
      <div id="quickChips" class="chip-scroll flex items-center gap-1.5 pb-1 pr-1">
        <button class="chip text-[11px] px-2 py-1" data-prompt="Agenda">Agenda</button>
        <button class="chip text-[11px] px-2 py-1" data-prompt="Venue Map">Venue Map</button>
        <button class="chip text-[11px] px-2 py-1" data-prompt="Speakers">Speakers</button>
        <button class="chip text-[11px] px-2 py-1" data-prompt="Help">Help</button>
      </div>
      <button id="btnToggleAsk" type="button"
              class="btn btn-plain ml-auto text-xs px-2 py-1.5"
              aria-expanded="false" aria-controls="askForm" aria-label="Toggle text input">
        Aa
      </button>
    </div>

    <!-- Primary mic button -->
    <div class="w-full grid place-items-center mt-1">
      <button id="btnHoldMic" type="button" aria-label="Hold to speak"
              oncontextmenu="return false" draggable="false"
              class="btn btn-brand btn-mic-rect select-none touch-none"
              style="position:relative; left:50%; transform:translateX(-50%);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 0 1-14 0m7 7v-2" />
        </svg>
        <span class="ml-2 font-semibold">Hold &amp; Speak</span>
      </button>
    </div>

    <!-- Toggleable Ask form (hidden by default) -->
    <form id="askForm" class="mt-2 hidden" autocomplete="off">
      <div class="flex items-stretch gap-1.5">
        <input id="txtAsk"
               type="text"
               placeholder="Type your question…"
               class="input text-xs px-2 py-2 leading-tight flex-1 min-w-0" />
        <button id="btnAsk" type="submit" class="btn btn-brand text-xs px-3 py-2 shrink-0">
          Ask
        </button>
      </div>
    </form>
  </div>
</footer>

<!-- Audio unlock (simple, no layout coupling) -->
<script>
(() => {
  const nudge = document.getElementById('audioNudge');
  const btn   = document.getElementById('btnEnableAudio');
  if (!btn) return;
  btn.addEventListener('click', async () => {
    try {
      if (window.HARCI_AVATAR?.ensureAudioUnlocked) {
        await window.HARCI_AVATAR.ensureAudioUnlocked();
      } else {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) {
          const ctx = new AC(); await ctx.resume();
          const osc = ctx.createOscillator(); const g = ctx.createGain();
          g.gain.value = 0; osc.connect(g).connect(ctx.destination);
          osc.start(); osc.stop(ctx.currentTime + 0.02);
        }
      }
      window.__audio_unlocked = true;
      try { window.HARCI_AVATAR?.setOutputMuted?.(false); } catch {}
    } catch {}
    nudge?.classList.add('hidden');
  }, { once: true });
})();
</script>

<!-- Ask toggle (mic vs text) -->
<script>
(() => {
  const btn  = document.getElementById('btnToggleAsk');
  const form = document.getElementById('askForm');
  if (!btn || !form) return;

  const setState = (open) => {
    document.body.classList.toggle('ask-open', open);
    form.classList.toggle('hidden', !open);
    btn.setAttribute('aria-expanded', String(open));
    btn.textContent = open ? 'Hide' : 'Aa';
  };

  btn.addEventListener('click', () => setState(!document.body.classList.contains('ask-open')));
  setState(false);
})();
</script>

{% endblock %}
